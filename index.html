<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>SunCulture Marketplace — Catalog</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --muted:#f4f6f8;
      --muted2:#eef2f6;
      --border:#e6ebf0;
      --text:#0f172a;
      --sub:#475569;
      --sub2:#64748b;
      --dark:#111827;
      --lime:#84cc16;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --shadow2: 0 8px 20px rgba(15,23,42,.08);
      --radius: 18px;
      --radius2: 14px;
      --focus: 0 0 0 3px rgba(132,204,22,.28);
      --focus2: 0 0 0 3px rgba(15,23,42,.18);
      --max: 1200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: linear-gradient(180deg, #fff, #fafbfd 28%, #f7f9fc 100%);
      color:var(--text);
      overflow-x:hidden;
    }
    .container{max-width:var(--max); margin:0 auto; padding:0 16px;}
    button,input,select{font:inherit}
    a{color:inherit}

    /* Header */
    .header{
      position:sticky; top:0; z-index:40;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,.92);
      border-bottom:1px solid var(--border);
    }
    .header__row{display:flex; align-items:center; gap:12px; padding:14px 0;}
    .brand{display:flex; align-items:center; gap:12px; min-width:240px;}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: radial-gradient(120% 120% at 20% 20%, rgba(132,204,22,.35), rgba(132,204,22,.12) 45%, rgba(17,24,39,.08) 100%),
                  linear-gradient(135deg, #ffffff, #f5ffe0);
      border:1px solid rgba(132,204,22,.22);
      box-shadow: 0 6px 20px rgba(132,204,22,.12);
      display:grid; place-items:center;
    }
    .logo svg{width:22px; height:22px; color:var(--dark)}
    .brand__text{display:flex; flex-direction:column; line-height:1.15}
    .brand__title{font-weight:900; letter-spacing:-.02em}
    .brand__sub{font-size:12px; color:var(--sub2); margin-top:2px}

    .search{flex:1; position:relative; min-width: 240px;}
    .search input{
      width:100%;
      border:1px solid var(--border);
      background:#fff;
      border-radius: 999px;
      padding:12px 42px 12px 42px;
      outline:none;
      box-shadow: 0 1px 0 rgba(15,23,42,.02);
    }
    .search input:focus{box-shadow: var(--focus)}
    .search .icon{
      position:absolute; left:14px; top:50%; transform:translateY(-50%);
      color: var(--sub2);
      width:18px; height:18px;
    }
    .search .clear{
      position:absolute; right:10px; top:50%; transform:translateY(-50%);
      width:30px; height:30px;
      display:grid; place-items:center;
      border:none; background:transparent; color:var(--sub2);
      border-radius:999px;
      cursor:pointer;
    }
    .search .clear:hover{background:var(--muted2); color:var(--text)}

    /* Suggestions dropdown */
    .suggest{
      position:absolute;
      left:0; right:0;
      top: calc(100% + 10px);
      background:#fff;
      border:1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
      z-index:60;
    }
    .suggest.open{display:block}
    .suggest .head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      background: linear-gradient(180deg, rgba(132,204,22,.10), rgba(255,255,255,0));
      border-bottom:1px solid var(--border);
      font-size:12px;
      color:var(--sub2);
      font-weight:900;
    }
    .suggest .list{max-height: 320px; overflow:auto}
    .sitem{
      width:100%;
      border:none;
      background:#fff;
      text-align:left;
      padding:10px 12px;
      cursor:pointer;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .sitem:hover, .sitem[aria-selected="true"]{
      background: var(--muted);
    }
    .sleft{min-width:0}
    .sname{font-weight:950; font-size:13px; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .smeta{margin-top:4px; font-size:12px; color:var(--sub); font-weight:800; line-height:1.3}
    .sprice{flex:none; text-align:right; font-weight:950; color:var(--dark); font-size:13px}
    .sprice small{display:block; margin-top:2px; font-size:11px; color:var(--sub2); font-weight:900}

    .controls{display:flex; align-items:center; gap:10px; min-width: 420px; justify-content:flex-end;}
    select{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 999px;
      padding:10px 12px;
      color:var(--text);
      outline:none;
    }
    select:focus{box-shadow: var(--focus2)}
    .btn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      font-weight:900;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .btn:hover{background:var(--muted); border-color:#d8e0e8}
    .btn:active{transform: translateY(1px)}
    .btn:focus{outline:none; box-shadow: var(--focus2)}
    .btn--primary{
      border-color: rgba(132,204,22,.35);
      background: linear-gradient(180deg, rgba(132,204,22,.20), rgba(132,204,22,.10));
    }
    .btn--primary:hover{background: linear-gradient(180deg, rgba(132,204,22,.28), rgba(132,204,22,.14))}
    .cart-btn{
      position:relative;
      background: var(--dark);
      color:#fff;
      border-color: rgba(17,24,39,.22);
    }
    .cart-btn:hover{background:#0b1220}
    .badge{
      min-width:22px; height:22px;
      border-radius:999px;
      background: rgba(255,255,255,.14);
      display:inline-grid; place-items:center;
      font-size:12px;
      padding:0 8px;
      font-weight:950;
    }

    .header__mobileRow{display:none; border-top:1px solid var(--border); background: rgba(255,255,255,.88); padding:10px 0;}
    .mobile-controls{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}

    /* Layout */
    .main{padding:18px 0 28px;}
    .grid{display:grid; grid-template-columns: 300px 1fr; gap:18px; align-items:start;}

    /* Sidebar */
    .sidebar{
      position:sticky; top: 92px;
      border:1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding:14px;
    }
    .sidebar__head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:4px 2px 10px;
      border-bottom:1px solid var(--border);
      margin-bottom:12px;
    }
    .sidebar__title{font-weight:950; letter-spacing:-.01em}
    .linkbtn{
      border:none; background:transparent;
      color: var(--sub);
      font-weight:950;
      cursor:pointer;
      border-radius:10px;
      padding:6px 8px;
    }
    .linkbtn:hover{background: var(--muted2); color:var(--text)}
    .section{margin:14px 0}
    .section h3{font-size:13px; margin:0 0 8px; color: var(--dark); letter-spacing:-.01em;}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .field{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding:10px 10px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .field span{font-size:12px; color:var(--sub2); font-weight:950}
    .field input{
      width:100%;
      border:none;
      outline:none;
      font-weight:900;
      color:var(--text);
      background:transparent;
    }
    .pills{display:grid; gap:8px;}
    .pills.two{grid-template-columns: 1fr 1fr}
    .pill{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding:10px 10px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      font-weight:950;
      color:var(--text);
      transition: background .15s ease, border-color .15s ease;
    }
    .pill:hover{background: var(--muted); border-color:#d8e0e8}
    .pill[aria-pressed=true]{background: var(--dark); border-color: rgba(17,24,39,.2); color:#fff;}
    .pill .mark{
      width:24px; height:24px; border-radius:999px;
      display:grid; place-items:center;
      background: var(--muted2);
      color: var(--sub);
      font-weight:950;
      flex:none;
    }
    .pill[aria-pressed=true] .mark{background: rgba(255,255,255,.14); color:#fff;}

    /* Summary */
    .summary{
      border:1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding:14px;
    }
    .summaryTop{display:flex; flex-wrap:wrap; align-items:flex-start; justify-content:space-between; gap:12px;}
    .meta{display:flex; flex-direction:column; gap:4px;}
    .meta .line1{color:var(--sub); font-weight:950}
    .meta .line1 b{color:var(--text)}
    .meta .line2{font-size:12px; color:var(--sub2); font-weight:900}
    .chips{margin-top:12px; display:flex; flex-wrap:wrap; gap:8px;}
    .chip{
      border:1px solid var(--border);
      background: var(--muted);
      border-radius: 999px;
      padding:7px 10px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:950;
      color:var(--text);
      max-width: 100%;
    }
    .chip span{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 360px}
    .chip button{
      width:24px; height:24px;
      border:none;
      background: rgba(17,24,39,.08);
      border-radius:999px;
      cursor:pointer;
      color: var(--sub);
      font-weight:950;
    }
    .chip button:hover{background: rgba(17,24,39,.14); color:var(--text)}

    /* Results list (simple, professional) */
    .items{margin-top:16px; display:grid; grid-template-columns: 1fr; gap:12px;}
    .item{
      border:1px solid var(--border);
      background:#fff;
      border-radius: var(--radius);
      box-shadow: 0 6px 18px rgba(15,23,42,.06);
      padding:14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      transition: transform .12s ease, box-shadow .16s ease, border-color .16s ease;
    }
    .item:hover{transform: translateY(-1px); box-shadow: var(--shadow2); border-color:#d8e0e8;}
    .ileft{min-width:0}
    .ititle{font-weight:950; letter-spacing:-.01em; font-size:15px; margin:0;}
    .iorigin{margin-top:6px; color:var(--sub); font-weight:900; font-size:13px; line-height:1.35;}
    .imeta{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;}
    .tag{
      font-size:12px;
      font-weight:950;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: var(--muted);
      color: var(--sub);
    }
    .tag.strong{border-color: rgba(132,204,22,.35); background: rgba(132,204,22,.14); color:#365314;}
    .tag.dark{border-color: rgba(17,24,39,.18); background: rgba(17,24,39,.06); color: var(--dark);}
    .iright{flex:none; text-align:right; display:flex; flex-direction:column; gap:10px; align-items:flex-end;}
    .iprice{font-weight:950; font-size:16px; color:var(--dark)}
    .iprice small{display:block; margin-top:2px; font-size:12px; color:var(--sub2); font-weight:900}
    .add{
      border:none;
      border-radius: 14px;
      padding:12px 12px;
      background: var(--dark);
      color:#fff;
      font-weight:950;
      cursor:pointer;
      transition: background .15s ease, transform .08s ease;
      min-width: 150px;
    }
    .add:hover{background:#0b1220}
    .add:active{transform: translateY(1px)}
    .add:disabled{background:#e2e8f0; color:#94a3b8; cursor:not-allowed;}

    /* Loading + empty */
    .loadingbar{
      margin-top:14px;
      border:1px solid var(--border);
      background:#fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding:12px 14px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      color:var(--sub);
      font-weight:950;
    }
    .loadingbar .pulse{
      height:10px;
      flex:1;
      border-radius:999px;
      background: linear-gradient(90deg, #eef2f6, #f7fafc, #eef2f6);
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer{0%{background-position:0% 0%}100%{background-position:200% 0%}}

    .empty{
      margin-top:16px;
      border:1px solid var(--border);
      background:#fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding:28px 18px;
      text-align:center;
      display:none;
    }
    .empty .icon{
      width:52px; height:52px;
      margin:0 auto;
      border-radius: 18px;
      background: var(--muted);
      border:1px solid var(--border);
      display:grid; place-items:center;
      color: var(--dark);
    }
    .empty h3{margin:14px 0 8px; font-weight:950}
    .empty p{margin:0 auto 16px; max-width: 520px; color:var(--sub); font-weight:900}
    .rowBtn{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}

    /* Pagination */
    .pager{
      margin-top:16px;
      border:1px solid var(--border);
      background:#fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding:12px 14px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .pager .left{color:var(--sub); font-weight:950}
    .pager .left b{color:var(--text)}
    .pages{display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .pbtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding:10px 12px;
      font-weight:950;
      cursor:pointer;
    }
    .pbtn:hover{background: var(--muted)}
    .pbtn:disabled{background:#f1f5f9; color:#94a3b8; cursor:not-allowed}
    .pbtn.active{background: var(--dark); color:#fff; border-color: rgba(17,24,39,.22)}
    .ellipsis{color:#94a3b8; font-weight:950; padding:0 2px}

    /* Overlay + drawers + modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(15,23,42,.45);
      z-index:60;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .overlay.open{opacity:1; pointer-events:auto}
    .drawer{
      position:fixed; top:0; bottom:0;
      width:min(420px, calc(100% - 36px));
      background:#fff;
      z-index:70;
      box-shadow: -10px 0 30px rgba(15,23,42,.18);
      transform: translateX(110%);
      transition: transform .18s ease;
      display:flex; flex-direction:column;
    }
    .drawer.left{
      left:0;
      transform: translateX(-110%);
      box-shadow: 10px 0 30px rgba(15,23,42,.18);
    }
    .drawer.open{transform: translateX(0)}
    .dhead{
      padding:14px 14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .dhead h2{margin:0; font-size:14px; font-weight:950; letter-spacing:-.01em;}
    .close{
      width:38px; height:38px;
      border:none;
      background: var(--muted);
      border-radius: 14px;
      cursor:pointer;
      font-weight:950;
      color: var(--dark);
    }
    .close:hover{background: var(--muted2)}
    .dbody{padding:14px; overflow:auto; flex:1}
    .dfoot{padding:14px; border-top:1px solid var(--border); background: rgba(255,255,255,.9)}
    .dfoot .row2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}

    /* Cart */
    .cartEmpty{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 18px;
      padding:18px;
      text-align:center;
    }
    .cartEmpty .icon{
      width:52px; height:52px; border-radius: 18px;
      margin:0 auto;
      background: var(--muted);
      border:1px solid var(--border);
      display:grid; place-items:center;
      color: var(--dark);
    }
    .cartEmpty h3{margin:14px 0 8px; font-weight:950}
    .cartEmpty p{margin:0 0 14px; color:var(--sub); font-weight:900; font-size:13px}
    .cartList{display:grid; gap:10px}
    .lineItem{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 18px;
      padding:12px;
      box-shadow: 0 6px 18px rgba(15,23,42,.05);
    }
    .liTop{display:flex; justify-content:space-between; gap:10px}
    .liName{font-weight:950; margin:0; font-size:14px}
    .liSub{margin:4px 0 0; font-size:12px; color:var(--sub2); font-weight:900}
    .liRemove{
      width:38px; height:38px;
      border:none;
      background: var(--muted);
      border-radius: 14px;
      cursor:pointer;
      font-weight:950;
      color: var(--dark);
      flex:none;
    }
    .liRemove:hover{background: var(--muted2)}
    .liBottom{
      margin-top:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .qctrl{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      border-radius: 16px;
      padding:8px;
      background:#fff;
      max-width: 220px;
    }
    .qctrl button{
      width:40px; height:40px;
      border:none;
      border-radius: 14px;
      cursor:pointer;
      font-weight:950;
      background: var(--muted);
      color: var(--dark);
    }
    .qctrl button:hover{background: var(--muted2)}
    .qctrl button:disabled{opacity:.5; cursor:not-allowed}
    .qctrl input{
      width:100%;
      border:none;
      outline:none;
      text-align:center;
      font-weight:950;
      font-size:14px;
    }
    .liTotal{font-weight:950; text-align:right}
    .liTotal small{display:block; font-size:12px; color:var(--sub2); font-weight:900; margin-top:2px}
    .toast{
      margin-top:10px;
      border-radius: 16px;
      border:1px solid rgba(132,204,22,.35);
      background: rgba(132,204,22,.16);
      color:#365314;
      padding:10px 12px;
      font-weight:950;
      font-size:13px;
      display:none;
    }
    .toast.show{display:block}

    footer{border-top:1px solid var(--border); background:#fff;}
    .foot{
      padding:18px 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      color: var(--sub);
      font-weight:900;
      font-size:13px;
    }
    .foot small{color:var(--sub2); font-weight:900}

    /* Responsive */
    @media (max-width: 920px){
      .controls{display:none}
      .header__mobileRow{display:block}
      .grid{grid-template-columns: 1fr}
      .sidebar{display:none}
      .brand__sub{display:none}
    }
    @media (max-width: 560px){
      .brand{min-width:unset}
      .search input{padding-left:40px}
      .suggest .sprice{display:none}
      .add{min-width: 130px}
    }
  </style>
</head>
<body>
  <header class="header" role="banner">
    <div class="container">
      <div class="header__row">
        <div class="brand" aria-label="SunCulture Marketplace">
          <div class="logo" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path fill="currentColor" d="M12 2l2.3 6.3H21l-5.4 3.8 2.1 6.4L12 14.7 6.3 18.5l2.1-6.4L3 8.3h6.7L12 2z"/>
            </svg>
          </div>
          <div class="brand__text">
            <div class="brand__title">SunCulture Marketplace</div>
            <div class="brand__sub">Simple offline catalog • Type to search products</div>
          </div>
        </div>

        <div class="search" role="search">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M10 4a6 6 0 104.47 10.03l4.25 4.24 1.41-1.41-4.24-4.25A6 6 0 0010 4zm0 2a4 4 0 110 8 4 4 0 010-8z"/>
          </svg>
          <input id="searchInput" type="text" placeholder="Search: arabica, tomatoes, Nakuru, Nairobi, organic…" autocomplete="off" />
          <button id="searchClear" class="clear" type="button" aria-label="Clear search" title="Clear">×</button>

          <div id="suggest" class="suggest" role="listbox" aria-label="Search suggestions">
            <div class="head">
              <span>Suggestions</span>
              <span id="suggestCount">0</span>
            </div>
            <div id="suggestList" class="list"></div>
          </div>
        </div>

        <div class="controls" aria-label="Header controls">
          <select id="categorySelect" aria-label="Category">
            <option value="All">All categories</option>
          </select>
          <select id="sortSelect" aria-label="Sort">
            <option value="relevance">Relevance</option>
            <option value="price_asc">Price: Low → High</option>
            <option value="price_desc">Price: High → Low</option>
          </select>
          <button id="cartOpenBtn" class="btn cart-btn" type="button" aria-label="Open cart">
            Cart <span id="cartCount" class="badge">0</span>
          </button>
        </div>
      </div>

      <div class="header__mobileRow">
        <div class="mobile-controls">
          <button id="filtersOpenBtn" class="btn btn--primary" type="button">Filters</button>
          <button id="cartOpenBtnMobile" class="btn cart-btn" type="button" aria-label="Open cart">
            Cart <span id="cartCountMobile" class="badge">0</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="main" role="main">
    <div class="container">
      <div class="grid">
        <aside class="sidebar" aria-label="Filters sidebar">
          <div class="sidebar__head">
            <div class="sidebar__title">Filters</div>
            <button id="filtersResetBtn" class="linkbtn" type="button">Reset</button>
          </div>
          <div id="filtersDesktop"></div>
        </aside>

        <section aria-label="Catalog results">
          <div class="summary">
            <div class="summaryTop">
              <div class="meta">
                <div class="line1" id="resultsMeta">Showing <b>0</b> results</div>
                <div class="line2" id="resultsSub">Sort: Relevance</div>
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                <button id="resetAllBtn" class="btn" type="button">Reset all</button>
                <button id="focusSearchBtn" class="btn btn--primary" type="button">Refine search</button>
              </div>
            </div>
            <div id="chips" class="chips" aria-label="Active filters"></div>
          </div>

          <div id="loadingbar" class="loadingbar" aria-live="polite">
            <div>Updating results…</div>
            <div class="pulse" aria-hidden="true"></div>
          </div>

          <div id="emptyArea" class="empty"></div>
          <div id="items" class="items" aria-label="Product results"></div>
          <div id="pager" class="pager" aria-label="Pagination"></div>
        </section>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="foot">
        <div><b style="color:var(--text)">SunCulture Marketplace</b> · Offline catalog prototype</div>
        <small>Save as <b>index.html</b> (not .txt) to run in Edge/Chrome · Demo data only</small>
      </div>
    </div>
  </footer>

  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <!-- Filters drawer (mobile) -->
  <aside id="filtersDrawer" class="drawer left" aria-label="Filters drawer" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="dhead">
      <h2>Filters</h2>
      <button class="close" type="button" id="filtersCloseBtn" aria-label="Close filters">×</button>
    </div>
    <div class="dbody" id="filtersMobile"></div>
    <div class="dfoot">
      <div class="row2">
        <button class="btn" id="filtersResetMobileBtn" type="button">Reset</button>
        <button class="btn btn--primary" id="filtersApplyMobileBtn" type="button">Apply</button>
      </div>
    </div>
  </aside>

  <!-- Cart drawer -->
  <aside id="cartDrawer" class="drawer" style="right:0" aria-label="Cart drawer" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="dhead">
      <h2>Cart</h2>
      <button class="close" type="button" id="cartCloseBtn" aria-label="Close cart">×</button>
    </div>
    <div class="dbody" id="cartBody"></div>
    <div class="dfoot">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;font-weight:950">
        <div style="color:var(--sub)">Subtotal</div>
        <div id="cartSubtotal" style="color:var(--text)">$0.00</div>
      </div>
      <div class="toast" id="checkoutToast">Demo only — checkout is disabled in this prototype.</div>
      <div class="row2" style="margin-top:12px">
        <button class="btn" id="clearCartBtn" type="button">Clear cart</button>
        <button class="btn btn--primary" id="checkoutBtn" type="button">Checkout</button>
      </div>
    </div>
  </aside>

  <script>
    ;(() => {
      const PAGE_SIZE = 12;

      const REGIONS = ['Kenya','Uganda','Tanzania','Rwanda','Ethiopia'];
      const TAGS = ['Verified','Organic','Fast Dispatch'];
      const CATEGORIES = ['Produce','Staples','Beverages','Spices','Nuts & Seeds'];

      // Mock products: includes Kenya-specific origin (county/town) for what you requested
      const PRODUCTS = [
        mk({ name:'Nakuru Roma Tomatoes', price:2.90, unit:'/kg', region:'Kenya', origin:'Nakuru County (Naivasha)', category:'Produce', tags:['Verified','Fast Dispatch'], inStock:true, seller:'GreenHills Co-op',
          shortOrigin:'Fresh Roma tomatoes from Naivasha, Nakuru—hand-sorted for firm texture and shelf life.'}),
        mk({ name:'Nyeri French Beans', price:3.70, unit:'/kg', region:'Kenya', origin:'Nyeri County (Karatina)', category:'Produce', tags:['Verified','Organic','Fast Dispatch'], inStock:true, seller:'Aberdare Produce',
          shortOrigin:'Crisp export-grade beans from Karatina, Nyeri—morning harvest and rapid cooling.'}),
        mk({ name:'Sukuma Wiki (Kale) Bundles', price:2.10, unit:'/bundle', region:'Kenya', origin:'Kiambu County (Limuru)', category:'Produce', tags:['Verified','Fast Dispatch'], inStock:true, seller:'UrbanGreens Nairobi',
          shortOrigin:'Daily-harvest sukuma wiki from Limuru, Kiambu—washed, trimmed, and packed promptly.'}),
        mk({ name:'Fresh Basil Bunches', price:1.20, unit:'/bunch', region:'Kenya', origin:'Kajiado County (Kitengela)', category:'Produce', tags:['Organic'], inStock:true, seller:'HerbCraft Nairobi',
          shortOrigin:'Fragrant basil from Kitengela, Kajiado—cut daily and packed to preserve aroma.'}),
        mk({ name:'Red Kidney Beans', price:3.10, unit:'/kg', region:'Kenya', origin:'Uasin Gishu (Eldoret)', category:'Staples', tags:['Verified'], inStock:true, seller:'Rift Valley Staples',
          shortOrigin:'Graded red kidney beans from Eldoret, Uasin Gishu—cleaned for low breakage.'}),
        mk({ name:'Maize Flour (Fine Milled)', price:1.40, unit:'/kg', region:'Kenya', origin:'Trans Nzoia (Kitale)', category:'Staples', tags:['Verified','Fast Dispatch'], inStock:true, seller:'Mavuno Mills',
          shortOrigin:'Fine maize flour milled in Kitale, Trans Nzoia—consistent texture for ugali and baking.'}),
        mk({ name:'Kenya Macadamia Nuts', price:22.00, unit:'/kg', region:'Kenya', origin:'Murang’a County (Kangema)', category:'Nuts & Seeds', tags:['Verified','Organic'], inStock:true, seller:'Highland Macas',
          shortOrigin:'Premium macadamias from Kangema, Murang’a—sorted and packed with moisture control.'}),
        mk({ name:'Groundnuts (Peanuts)', price:4.60, unit:'/kg', region:'Kenya', origin:'Busia County (Bumala)', category:'Nuts & Seeds', tags:['Organic'], inStock:true, seller:'Savannah Nut Co.',
          shortOrigin:'Roast-ready groundnuts from Bumala, Busia—uniform sizing for peanut butter and snacks.'}),
        mk({ name:'Uganda Arabica Coffee Beans', price:12.50, unit:'/kg', region:'Uganda', origin:'Mt. Elgon (Mbale)', category:'Beverages', tags:['Verified','Fast Dispatch'], inStock:true, seller:'Pearl Highlands',
          shortOrigin:'Single-origin arabica from Mbale (Mt. Elgon)—washed process with citrus notes.'}),
        mk({ name:'Ethiopian Yirgacheffe Coffee', price:14.90, unit:'/kg', region:'Ethiopia', origin:'Yirgacheffe', category:'Beverages', tags:['Verified','Organic'], inStock:true, seller:'BlueNile Export',
          shortOrigin:'Specialty Yirgacheffe—floral aroma, bright acidity, packed in moisture-barrier liners.'}),
        mk({ name:'Rwanda Black Tea', price:8.20, unit:'/kg', region:'Rwanda', origin:'Western Province (Nyamasheke)', category:'Beverages', tags:['Verified'], inStock:true, seller:'Kivu Estates',
          shortOrigin:'High-grown tea from Nyamasheke—brisk cup profile and clean finish.'}),
        mk({ name:'Tanzanian Long-Grain Rice', price:2.60, unit:'/kg', region:'Tanzania', origin:'Morogoro', category:'Staples', tags:[], inStock:true, seller:'Coastline Mills',
          shortOrigin:'Long-grain rice from Morogoro—low breakage and consistent grain length.'}),
        mk({ name:'Ethiopian Berbere Spice', price:7.90, unit:'/500g', region:'Ethiopia', origin:'Addis Ababa', category:'Spices', tags:['Verified','Organic'], inStock:true, seller:'Red Earth Spices',
          shortOrigin:'Traditional berbere blend—warm heat and deep aroma, milled for consistency.'}),
        mk({ name:'Zanzibar Cloves (Whole)', price:18.00, unit:'/kg', region:'Tanzania', origin:'Zanzibar', category:'Spices', tags:['Verified','Fast Dispatch'], inStock:true, seller:'Zanzibar Harvest',
          shortOrigin:'Whole cloves from Zanzibar—high essential oil content for strong aroma.'}),
        mk({ name:'Uganda Fresh Ginger', price:5.10, unit:'/kg', region:'Uganda', origin:'Jinja', category:'Spices', tags:['Verified','Organic'], inStock:true, seller:'Nile Root Co.',
          shortOrigin:'Fresh ginger from Jinja—selected for oil content and firmness.'}),
        mk({ name:'Tanzania Cashew Kernels', price:16.50, unit:'/kg', region:'Tanzania', origin:'Mtwara', category:'Nuts & Seeds', tags:['Verified','Fast Dispatch'], inStock:true, seller:'Mtwara Cashews',
          shortOrigin:'Premium cashew kernels from Mtwara—graded for size and integrity.'}),
        mk({ name:'Rwanda Sesame Seeds', price:6.80, unit:'/kg', region:'Rwanda', origin:'Kigali', category:'Nuts & Seeds', tags:['Verified'], inStock:true, seller:'Kigali Seeds',
          shortOrigin:'Clean sesame from Kigali—suitable for tahini and baking, low foreign matter.'}),
        mk({ name:'Ethiopian Teff (Ivory)', price:5.80, unit:'/kg', region:'Ethiopia', origin:'Oromia', category:'Staples', tags:['Verified'], inStock:true, seller:'Addis Grain House',
          shortOrigin:'Premium ivory teff from Oromia—cleaned and graded for injera performance.'}),
        mk({ name:'Rwanda Irish Potatoes', price:1.60, unit:'/kg', region:'Rwanda', origin:'Musanze', category:'Produce', tags:['Verified'], inStock:true, seller:'Musanze Select',
          shortOrigin:'Highland potatoes from Musanze—graded for size and packed to reduce bruising.'}),
        mk({ name:'Uganda Pineapples (Sweet Gold)', price:1.90, unit:'/each', region:'Uganda', origin:'Luwero', category:'Produce', tags:['Organic'], inStock:true, seller:'Equator Fruit Co.',
          shortOrigin:'Sweet Gold pineapples from Luwero—selected at optimal maturity for juice and fresh packs.'}),
        mk({ name:'Ethiopia Mangoes (Seasonal)', price:2.80, unit:'/kg', region:'Ethiopia', origin:'SNNPR (Hawassa)', category:'Produce', tags:['Fast Dispatch'], inStock:false, seller:'Omo Valley Fruits',
          shortOrigin:'Seasonal mangoes from Hawassa—availability varies week to week.'}),
        mk({ name:'Lake Victoria Spice Mix', price:6.50, unit:'/500g', region:'Uganda', origin:'Entebbe', category:'Spices', tags:['Fast Dispatch'], inStock:true, seller:'SunLake Seasonings',
          shortOrigin:'Savory spice mix from Entebbe—balanced blend for fish, grills, and vegetables.'}),
        mk({ name:'Nairobi Market Bananas (Matooke)', price:2.20, unit:'/kg', region:'Uganda', origin:'Kampala', category:'Produce', tags:['Verified'], inStock:true, seller:'Kampala FarmLink',
          shortOrigin:'Matooke bananas aggregated in Kampala—consistent sizing for steaming and roasting.'}),
        mk({ name:'Tanzania Black Peppercorns', price:19.50, unit:'/kg', region:'Tanzania', origin:'Tanga', category:'Spices', tags:['Verified'], inStock:true, seller:'Coastal Pepper Co.',
          shortOrigin:'Whole peppercorns from Tanga—strong pungency, suitable for grinding and blends.'}),
        mk({ name:'Uganda Dried Chili Flakes', price:9.90, unit:'/kg', region:'Uganda', origin:'Masaka', category:'Spices', tags:['Verified','Fast Dispatch'], inStock:true, seller:'HotSun Foods',
          shortOrigin:'Sun-dried chili flakes from Masaka—controlled heat and consistent flake size.'}),
        mk({ name:'Kenya Coriander (Dhania) Bunches', price:1.10, unit:'/bunch', region:'Kenya', origin:'Narok County (Suswa)', category:'Produce', tags:['Fast Dispatch'], inStock:true, seller:'Rift Herbs',
          shortOrigin:'Fresh dhania from Suswa, Narok—bright aroma for kitchen bundles and retail.'}),
        mk({ name:'Kiambu Baby Spinach', price:3.20, unit:'/kg', region:'Kenya', origin:'Kiambu County (Githunguri)', category:'Produce', tags:['Verified','Organic'], inStock:true, seller:'Highland Leaf',
          shortOrigin:'Baby spinach from Githunguri, Kiambu—tender leaves cooled quickly for freshness.'}),
        mk({ name:'Mombasa Coconut Chips', price:7.10, unit:'/500g', region:'Kenya', origin:'Kilifi County (Watamu)', category:'Nuts & Seeds', tags:['Organic'], inStock:true, seller:'Coast Pantry',
          shortOrigin:'Coconut chips from Watamu, Kilifi—lightly toasted for snack packs and toppings.'}),
        mk({ name:'Kisumu Dried Tilapia Seasoning', price:5.90, unit:'/500g', region:'Kenya', origin:'Kisumu (Dunga Beach)', category:'Spices', tags:['Verified'], inStock:true, seller:'LakeShore Blends',
          shortOrigin:'Seasoning blend inspired by Kisumu—crafted for grilled fish and vegetables.'}),
      ];

      function mk({name, price, unit, region, origin, category, tags, inStock, seller, shortOrigin}){
        return {
          id: slugId(name),
          name,
          price,
          unit,
          region,
          origin,
          category,
          tags: tags || [],
          inStock: !!inStock,
          seller,
          shortOrigin,
        };
      }
      function slugId(seed){
        const base = seed.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
        let h=2166136261;
        for(let i=0;i<seed.length;i++){ h ^= seed.charCodeAt(i); h = Math.imul(h, 16777619); }
        return `${base}-${(h>>>0).toString(16).slice(0,8)}`;
      }

      // State
      const state = {
        searchRaw: '',
        search: '',
        category: 'All',
        sort: 'relevance',
        filters: {
          regions: [],
          tags: [],
          priceMin: null,
          priceMax: null,
          inStockOnly: false
        },
        page: 1,
        loading: false,
        cart: loadCart(),
        suggestOpen: false,
        suggestIndex: -1,
        lastRenderToken: 0
      };

      // Elements
      const el = {
        searchInput: document.getElementById('searchInput'),
        searchClear: document.getElementById('searchClear'),
        suggest: document.getElementById('suggest'),
        suggestList: document.getElementById('suggestList'),
        suggestCount: document.getElementById('suggestCount'),

        categorySelect: document.getElementById('categorySelect'),
        sortSelect: document.getElementById('sortSelect'),

        cartOpenBtn: document.getElementById('cartOpenBtn'),
        cartOpenBtnMobile: document.getElementById('cartOpenBtnMobile'),
        cartCount: document.getElementById('cartCount'),
        cartCountMobile: document.getElementById('cartCountMobile'),

        filtersOpenBtn: document.getElementById('filtersOpenBtn'),
        filtersResetBtn: document.getElementById('filtersResetBtn'),
        filtersDesktop: document.getElementById('filtersDesktop'),
        filtersMobile: document.getElementById('filtersMobile'),
        filtersDrawer: document.getElementById('filtersDrawer'),
        filtersCloseBtn: document.getElementById('filtersCloseBtn'),
        filtersResetMobileBtn: document.getElementById('filtersResetMobileBtn'),
        filtersApplyMobileBtn: document.getElementById('filtersApplyMobileBtn'),

        resultsMeta: document.getElementById('resultsMeta'),
        resultsSub: document.getElementById('resultsSub'),
        chips: document.getElementById('chips'),

        loadingbar: document.getElementById('loadingbar'),
        emptyArea: document.getElementById('emptyArea'),
        items: document.getElementById('items'),
        pager: document.getElementById('pager'),

        resetAllBtn: document.getElementById('resetAllBtn'),
        focusSearchBtn: document.getElementById('focusSearchBtn'),

        overlay: document.getElementById('overlay'),
        cartDrawer: document.getElementById('cartDrawer'),
        cartCloseBtn: document.getElementById('cartCloseBtn'),
        cartBody: document.getElementById('cartBody'),
        cartSubtotal: document.getElementById('cartSubtotal'),
        clearCartBtn: document.getElementById('clearCartBtn'),
        checkoutBtn: document.getElementById('checkoutBtn'),
        checkoutToast: document.getElementById('checkoutToast'),
      };

      // Init
      initCategorySelect();
      initHandlers();
      renderFiltersUI();
      syncCartBadge();
      scheduleRender(); // initial

      function initCategorySelect(){
        const categories = Array.from(new Set(PRODUCTS.map(p=>p.category))).sort();
        for(const c of categories){
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          el.categorySelect.appendChild(opt);
        }
      }

      function initHandlers(){
        // Debounced search + suggestions + stable loading simulation (never loops)
        let debounceTimer = null;

        el.searchInput.addEventListener('input', (e) => {
          state.searchRaw = e.target.value || '';
          el.searchClear.style.visibility = state.searchRaw ? 'visible' : 'hidden';
          state.suggestIndex = -1;

          if(debounceTimer) clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            state.search = state.searchRaw.trim();
            state.page = 1;
            // show suggestions if query
            if(state.search.length >= 2) openSuggest();
            else closeSuggest();
            scheduleRender(true);
          }, 250);
        });

        el.searchInput.addEventListener('keydown', (e) => {
          if(e.key === 'Escape'){
            e.preventDefault();
            state.searchRaw = '';
            state.search = '';
            el.searchInput.value = '';
            el.searchClear.style.visibility = 'hidden';
            closeSuggest();
            state.page = 1;
            scheduleRender(true);
            return;
          }

          if(el.suggest.classList.contains('open')){
            const items = Array.from(el.suggestList.querySelectorAll('[data-sid]'));
            if(e.key === 'ArrowDown'){
              e.preventDefault();
              state.suggestIndex = Math.min(items.length - 1, state.suggestIndex + 1);
              syncSuggestSelection(items);
            } else if(e.key === 'ArrowUp'){
              e.preventDefault();
              state.suggestIndex = Math.max(-1, state.suggestIndex - 1);
              syncSuggestSelection(items);
            } else if(e.key === 'Enter'){
              if(state.suggestIndex >= 0 && items[state.suggestIndex]){
                e.preventDefault();
                items[state.suggestIndex].click();
              }
            }
          }
        });

        el.searchClear.addEventListener('click', () => {
          state.searchRaw = '';
          state.search = '';
          el.searchInput.value = '';
          el.searchClear.style.visibility = 'hidden';
          closeSuggest();
          state.page = 1;
          scheduleRender(true);
          el.searchInput.focus();
        });
        el.searchClear.style.visibility = 'hidden';

        el.categorySelect.addEventListener('change', (e) => {
          state.category = e.target.value;
          state.page = 1;
          scheduleRender(true);
        });

        el.sortSelect.addEventListener('change', (e) => {
          state.sort = e.target.value;
          state.page = 1;
          scheduleRender(true);
        });

        el.filtersResetBtn.addEventListener('click', () => {
          resetOnlyFilters();
          scheduleRender(true);
        });

        el.resetAllBtn.addEventListener('click', () => {
          resetAll();
          scheduleRender(true);
        });

        el.focusSearchBtn.addEventListener('click', () => el.searchInput.focus());

        // Click outside closes suggestions
        document.addEventListener('mousedown', (e) => {
          const withinSearch = el.searchInput.contains(e.target) || el.suggest.contains(e.target);
          if(!withinSearch) closeSuggest();
        });

        // Mobile filters drawer
        el.filtersOpenBtn.addEventListener('click', () => openDrawer('filters'));
        el.filtersCloseBtn.addEventListener('click', () => closeDrawer());
        el.filtersResetMobileBtn.addEventListener('click', () => {
          resetOnlyFilters();
          renderFiltersUI();
          scheduleRender(true);
        });
        el.filtersApplyMobileBtn.addEventListener('click', () => closeDrawer());

        // Cart
        el.cartOpenBtn.addEventListener('click', () => openDrawer('cart'));
        el.cartOpenBtnMobile.addEventListener('click', () => openDrawer('cart'));
        el.cartCloseBtn.addEventListener('click', () => closeDrawer());
        el.clearCartBtn.addEventListener('click', () => {
          state.cart = [];
          saveCart(state.cart);
          syncCartBadge();
          renderCart();
        });
        el.checkoutBtn.addEventListener('click', () => {
          el.checkoutToast.classList.add('show');
          setTimeout(()=>el.checkoutToast.classList.remove('show'), 2200);
        });

        // Overlay closes
        el.overlay.addEventListener('mousedown', () => closeDrawer());

        // Escape closes drawer
        window.addEventListener('keydown', (e) => {
          if(e.key === 'Escape'){
            closeDrawer();
            closeSuggest();
          }
        });
      }

      function syncSuggestSelection(items){
        items.forEach((it, i) => it.setAttribute('aria-selected', i === state.suggestIndex ? 'true' : 'false'));
        if(state.suggestIndex >= 0 && items[state.suggestIndex]){
          items[state.suggestIndex].scrollIntoView({block:'nearest'});
        }
      }

      function openSuggest(){
        renderSuggest();
        el.suggest.classList.add('open');
      }
      function closeSuggest(){
        state.suggestIndex = -1;
        el.suggest.classList.remove('open');
      }

      function renderSuggest(){
        const q = state.search.trim().toLowerCase();
        if(!q || q.length < 2){
          el.suggestList.innerHTML = '';
          el.suggestCount.textContent = '0';
          return;
        }
        const matches = sortItems(applyFilters(PRODUCTS, {suggestOnly:true})).slice(0, 8);
        el.suggestCount.textContent = String(matches.length);

        el.suggestList.innerHTML = matches.map(p => `
          <button class="sitem" type="button" role="option" aria-selected="false" data-sid="${escapeAttr(p.id)}">
            <div class="sleft">
              <div class="sname">${escapeHtml(p.name)}</div>
              <div class="smeta">${escapeHtml(p.origin)} · ${escapeHtml(p.category)}${p.tags.length ? ' · ' + escapeHtml(p.tags.join(', ')) : ''}</div>
            </div>
            <div class="sprice">${formatMoney(p.price)}<small>${escapeHtml(p.unit)}</small></div>
          </button>
        `).join('');

        matches.forEach(p => {
          const btn = el.suggestList.querySelector(`[data-sid="${cssEscape(p.id)}"]`);
          if(btn){
            btn.addEventListener('click', () => {
              // When clicking a suggestion: set search to product name for clarity, then render results
              state.searchRaw = p.name;
              state.search = p.name;
              el.searchInput.value = p.name;
              el.searchClear.style.visibility = 'visible';
              closeSuggest();
              state.page = 1;
              scheduleRender(true);
            });
          }
        });
      }

      // Filters UI
      function renderFiltersUI(){
        el.filtersDesktop.innerHTML = '';
        el.filtersMobile.innerHTML = '';
        el.filtersDesktop.appendChild(buildFiltersForm());
        el.filtersMobile.appendChild(buildFiltersForm());
      }

      function buildFiltersForm(){
        const root = document.createElement('div');

        root.appendChild(sectionTitle('Price (USD)'));
        const row = document.createElement('div');
        row.className = 'row';
        row.appendChild(fieldMoney('Min', state.filters.priceMin, (val) => { state.filters.priceMin = val; state.page=1; scheduleRender(true); }));
        row.appendChild(fieldMoney('Max', state.filters.priceMax, (val) => { state.filters.priceMax = val; state.page=1; scheduleRender(true); }));
        root.appendChild(row);

        root.appendChild(sectionTitle('Regions'));
        root.appendChild(pillsMulti(REGIONS, state.filters.regions, (val) => { toggleInArray(state.filters.regions, val); state.page=1; scheduleRender(true); }, true));

        root.appendChild(sectionTitle('Tags'));
        root.appendChild(pillsMulti(TAGS, state.filters.tags, (val) => { toggleInArray(state.filters.tags, val); state.page=1; scheduleRender(true); }, true));

        root.appendChild(sectionTitle('Availability'));
        const stock = document.createElement('button');
        stock.type = 'button';
        stock.className = 'pill';
        stock.setAttribute('aria-pressed', state.filters.inStockOnly ? 'true' : 'false');
        stock.innerHTML = `<span>In stock only</span><span class="mark">${state.filters.inStockOnly ? '✓' : '+'}</span>`;
        stock.addEventListener('click', () => {
          state.filters.inStockOnly = !state.filters.inStockOnly;
          stock.setAttribute('aria-pressed', state.filters.inStockOnly ? 'true' : 'false');
          stock.querySelector('.mark').textContent = state.filters.inStockOnly ? '✓' : '+';
          state.page = 1;
          scheduleRender(true);
        });
        root.appendChild(stock);

        return root;
      }

      function sectionTitle(text){
        const h = document.createElement('div');
        h.className = 'section';
        const title = document.createElement('h3');
        title.textContent = text;
        h.appendChild(title);
        return h;
      }

      function fieldMoney(label, value, onChange){
        const wrap = document.createElement('div');
        wrap.innerHTML = `
          <label style="display:block;font-size:12px;color:var(--sub2);font-weight:950;margin-bottom:6px">${label}</label>
          <div class="field">
            <span>$</span>
            <input inputmode="numeric" placeholder="Any" value="${value==null?'':String(value)}" />
          </div>
        `;
        const input = wrap.querySelector('input');
        input.addEventListener('input', () => {
          const raw = input.value.trim();
          if(!raw){ onChange(null); return; }
          const n = Number(raw);
          if(Number.isFinite(n)) onChange(clamp(Math.round(n*100)/100, 0, 99999));
        });
        return wrap;
      }

      function pillsMulti(options, selected, onToggle, twoCols){
        const wrap = document.createElement('div');
        wrap.className = 'pills' + (twoCols ? ' two' : '');
        options.forEach(opt => {
          const isOn = selected.includes(opt);
          const b = document.createElement('button');
          b.type='button';
          b.className='pill';
          b.setAttribute('aria-pressed', isOn ? 'true' : 'false');
          b.innerHTML = `<span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(opt)}</span><span class="mark">${isOn?'✓':'+'}</span>`;
          b.addEventListener('click', () => {
            const nowOn = b.getAttribute('aria-pressed') !== 'true';
            b.setAttribute('aria-pressed', String(nowOn));
            b.querySelector('.mark').textContent = nowOn ? '✓' : '+';
            onToggle(opt, nowOn);
          });
          wrap.appendChild(b);
        });
        return wrap;
      }

      function toggleInArray(arr, val){
        const i = arr.indexOf(val);
        if(i >= 0) arr.splice(i,1);
        else arr.push(val);
      }

      // Stable loading simulation: one timer per change, never loops
      let renderTimer = null;
      function scheduleRender(withLoading){
        const token = ++state.lastRenderToken;

        if(renderTimer) clearTimeout(renderTimer);

        if(withLoading){
          state.loading = true;
          el.loadingbar.style.display = 'flex';
          // suggestions can still appear; update them immediately
          if(state.search.length >= 2) renderSuggest();
        } else {
          state.loading = false;
          el.loadingbar.style.display = 'none';
        }

        // Ensure a single completion for this token
        renderTimer = setTimeout(() => {
          if(token !== state.lastRenderToken) return; // superseded
          state.loading = false;
          el.loadingbar.style.display = 'none';
          render();
        }, withLoading ? 420 : 0);

        if(!withLoading){
          render();
        }
      }

      function render(){
        renderSummary();
        renderChips();

        const filtered = sortItems(applyFilters(PRODUCTS));
        const total = filtered.length;
        const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        state.page = clamp(state.page, 1, totalPages);

        if(total === 0){
          el.items.innerHTML = '';
          el.pager.style.display = 'none';
          renderEmpty();
          return;
        } else {
          el.emptyArea.style.display = 'none';
        }

        const start = (state.page - 1) * PAGE_SIZE;
        const pageItems = filtered.slice(start, start + PAGE_SIZE);

        el.items.innerHTML = pageItems.map(itemHtml).join('');
        pageItems.forEach(p => {
          const addBtn = el.items.querySelector(`[data-add="${cssEscape(p.id)}"]`);
          if(addBtn){
            addBtn.addEventListener('click', () => addToCart(p.id, 1));
          }
        });

        renderPager(total, totalPages);
      }

      function renderSummary(){
        const filtered = sortItems(applyFilters(PRODUCTS));
        const total = filtered.length;

        const catText = (state.category !== 'All') ? ` in <b>${escapeHtml(state.category)}</b>` : '';
        el.resultsMeta.innerHTML = `Showing <b>${total}</b> result${total===1?'':'s'}${catText}`;
        el.resultsSub.textContent = `Sort: ${sortLabel(state.sort)}${state.search ? ` · Keyword: “${state.search}”` : ''}`;
      }

      function sortLabel(v){
        return ({
          relevance:'Relevance',
          price_asc:'Price: Low → High',
          price_desc:'Price: High → Low',
        })[v] || 'Relevance';
      }

      function renderChips(){
        const chips = [];

        if(state.category !== 'All'){
          chips.push({key:'category', label:`Category: ${state.category}`, remove: () => { state.category='All'; el.categorySelect.value='All'; state.page=1; scheduleRender(true); }});
        }
        if(state.search){
          chips.push({key:'search', label:`Search: “${state.search}”`, remove: () => {
            state.search=''; state.searchRaw='';
            el.searchInput.value=''; el.searchClear.style.visibility='hidden';
            closeSuggest();
            state.page=1;
            scheduleRender(true);
          }});
        }
        if(state.filters.priceMin != null || state.filters.priceMax != null){
          const min = state.filters.priceMin != null ? `$${state.filters.priceMin.toFixed(2)}` : 'Any';
          const max = state.filters.priceMax != null ? `$${state.filters.priceMax.toFixed(2)}` : 'Any';
          chips.push({key:'price', label:`Price: ${min} – ${max}`, remove: () => { state.filters.priceMin=null; state.filters.priceMax=null; renderFiltersUI(); state.page=1; scheduleRender(true); }});
        }
        if(state.filters.inStockOnly){
          chips.push({key:'stock', label:'In stock only', remove: () => { state.filters.inStockOnly=false; renderFiltersUI(); state.page=1; scheduleRender(true); }});
        }
        state.filters.regions.forEach(r => chips.push({key:`r:${r}`, label:`Region: ${r}`, remove: () => { removeFromArray(state.filters.regions, r); renderFiltersUI(); state.page=1; scheduleRender(true); }}));
        state.filters.tags.forEach(t => chips.push({key:`t:${t}`, label:`Tag: ${t}`, remove: () => { removeFromArray(state.filters.tags, t); renderFiltersUI(); state.page=1; scheduleRender(true); }}));

        if(chips.length === 0){
          el.chips.innerHTML = `<div style="color:var(--sub);font-weight:900">Tip: search by product (arabica), place (Nakuru/Naivasha), region (Kenya), or tags (organic).</div>`;
          return;
        }

        el.chips.innerHTML = chips.map(c => `
          <div class="chip" data-chip="${escapeAttr(c.key)}">
            <span>${escapeHtml(c.label)}</span>
            <button type="button" aria-label="Remove ${escapeAttr(c.label)}">×</button>
          </div>
        `).join('');

        chips.forEach(c => {
          const chip = el.chips.querySelector(`[data-chip="${cssEscape(c.key)}"]`);
          if(chip){
            chip.querySelector('button').addEventListener('click', c.remove);
          }
        });
      }

      function renderEmpty(){
        el.emptyArea.style.display = 'block';
        el.emptyArea.innerHTML = `
          <div class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="22" height="22">
              <path fill="currentColor" d="M10 4h4l1 2h6v2H3V6h6l1-2zm-4 6h12l-1 10H7L6 10zm4 2v6h2v-6H10zm4 0v6h2v-6h-2z"/>
            </svg>
          </div>
          <h3>No results found</h3>
          <p>Try broadening your search, removing some filters, or resetting to the default view.</p>
          <div class="rowBtn">
            <button class="btn" type="button" id="emptyResetFilters">Reset filters</button>
            <button class="btn btn--primary" type="button" id="emptyResetAll">Reset all</button>
          </div>
        `;
        document.getElementById('emptyResetFilters').addEventListener('click', () => {
          resetOnlyFilters();
          renderFiltersUI();
          scheduleRender(true);
        });
        document.getElementById('emptyResetAll').addEventListener('click', () => {
          resetAll();
          scheduleRender(true);
        });
      }

      function itemHtml(p){
        const tagHtml = [
          `<span class="tag dark">${escapeHtml(p.category)}</span>`,
          `<span class="tag">${escapeHtml(p.region)}</span>`,
          ...p.tags.map(t => `<span class="tag strong">${escapeHtml(t)}</span>`)
        ].join('');

        return `
          <article class="item">
            <div class="ileft">
              <p class="ititle">${escapeHtml(p.name)}</p>
              <div class="iorigin">${escapeHtml(p.shortOrigin)}</div>
              <div class="imeta">${tagHtml}</div>
              <div style="margin-top:10px;font-size:12px;color:var(--sub2);font-weight:900">
                Origin: ${escapeHtml(p.origin)} · Seller: ${escapeHtml(p.seller)}
              </div>
            </div>
            <div class="iright">
              <div class="iprice">${formatMoney(p.price)}<small>${escapeHtml(p.unit)}</small></div>
              <button class="add" type="button" data-add="${escapeAttr(p.id)}" ${p.inStock ? '' : 'disabled'}>
                ${p.inStock ? 'Add to cart' : 'Out of stock'}
              </button>
            </div>
          </article>
        `;
      }

      function renderPager(total, totalPages){
        el.pager.style.display = totalPages > 1 ? 'flex' : 'none';
        if(totalPages <= 1) return;

        const current = state.page;

        const windowSize = 5;
        const start = Math.max(1, current - Math.floor(windowSize/2));
        const end = Math.min(totalPages, start + windowSize - 1);
        const adjustedStart = Math.max(1, end - windowSize + 1);

        const pages = [];
        for(let p=adjustedStart; p<=end; p++) pages.push(p);

        const left = `<div class="left">Page <b>${current}</b> of <b>${totalPages}</b></div>`;
        const buttons = [];

        buttons.push(`<button class="pbtn" type="button" data-nav="${current-1}" ${current===1?'disabled':''}>Prev</button>`);

        if(adjustedStart > 1){
          buttons.push(`<button class="pbtn" type="button" data-page="1">1</button>`);
          buttons.push(`<span class="ellipsis">…</span>`);
        }

        pages.forEach(p => buttons.push(`<button class="pbtn ${p===current?'active':''}" type="button" data-page="${p}" ${p===current?'aria-current="page"':''}>${p}</button>`));

        if(end < totalPages){
          buttons.push(`<span class="ellipsis">…</span>`);
          buttons.push(`<button class="pbtn" type="button" data-page="${totalPages}">${totalPages}</button>`);
        }

        buttons.push(`<button class="pbtn" type="button" data-nav="${current+1}" ${current===totalPages?'disabled':''}>Next</button>`);

        el.pager.innerHTML = `${left}<div class="pages">${buttons.join('')}</div>`;

        el.pager.querySelectorAll('[data-page]').forEach(b => {
          b.addEventListener('click', () => { state.page = Number(b.getAttribute('data-page')); scheduleRender(true); });
        });
        el.pager.querySelectorAll('[data-nav]').forEach(b => {
          b.addEventListener('click', () => { state.page = clamp(Number(b.getAttribute('data-nav')), 1, totalPages); scheduleRender(true); });
        });
      }

      // Filtering + sorting
      function applyFilters(items, opts){
        const q = (state.search || '').trim().toLowerCase();
        return items.filter(p => {
          if(state.category !== 'All' && p.category !== state.category) return false;

          if(state.filters.inStockOnly && !p.inStock) return false;

          if(state.filters.priceMin != null && p.price < state.filters.priceMin) return false;
          if(state.filters.priceMax != null && p.price > state.filters.priceMax) return false;

          if(state.filters.regions.length && !state.filters.regions.includes(p.region)) return false;

          if(state.filters.tags.length){
            for(const t of state.filters.tags){
              if(!p.tags.includes(t)) return false;
            }
          }

          if(q){
            const hay = `${p.name} ${p.shortOrigin} ${p.origin} ${p.category} ${p.region} ${p.seller} ${p.tags.join(' ')}`.toLowerCase();
            if(!hay.includes(q)) return false;
          }

          return true;
        });
      }

      function relevanceScore(p){
        const q = (state.search || '').trim().toLowerCase();
        if(!q) return (p.tags.includes('Verified') ? 50 : 0) + (p.tags.includes('Organic') ? 8 : 0) + (p.tags.includes('Fast Dispatch') ? 6 : 0);

        const name = p.name.toLowerCase();
        const origin = (p.shortOrigin + ' ' + p.origin).toLowerCase();
        const seller = p.seller.toLowerCase();

        const nameExact = name.includes(q) ? 1 : 0;
        const namePrefix = name.split(/\s+/).some(w => w.startsWith(q)) ? 1 : 0;
        const originMatch = origin.includes(q) ? 1 : 0;
        const sellerMatch = seller.includes(q) ? 1 : 0;

        const verifiedScore = p.tags.includes('Verified') ? 10 : 0;

        return (nameExact ? 120 : (namePrefix ? 80 : 0))
          + (originMatch ? 20 : 0)
          + (sellerMatch ? 10 : 0)
          + verifiedScore
          + (p.tags.includes('Fast Dispatch') ? 2 : 0);
      }

      function sortItems(items){
        const s = state.sort;
        return items.slice().sort((a,b) => {
          switch(s){
            case 'price_asc': return (a.price - b.price) || (relevanceScore(b) - relevanceScore(a));
            case 'price_desc': return (b.price - a.price) || (relevanceScore(b) - relevanceScore(a));
            case 'relevance':
            default: return relevanceScore(b) - relevanceScore(a);
          }
        });
      }

      // Reset
      function resetOnlyFilters(){
        state.filters = { regions: [], tags: [], priceMin: null, priceMax: null, inStockOnly: false };
      }
      function resetAll(){
        state.searchRaw = '';
        state.search = '';
        el.searchInput.value = '';
        el.searchClear.style.visibility = 'hidden';
        closeSuggest();

        state.category = 'All';
        el.categorySelect.value = 'All';

        state.sort = 'relevance';
        el.sortSelect.value = 'relevance';

        resetOnlyFilters();
        renderFiltersUI();

        state.page = 1;
      }

      // Drawer open/close
      function openDrawer(which){
        el.overlay.classList.add('open');
        if(which === 'filters'){
          el.filtersDrawer.classList.add('open');
          el.filtersDrawer.setAttribute('aria-hidden','false');
          el.cartDrawer.classList.remove('open');
          el.cartDrawer.setAttribute('aria-hidden','true');
          el.checkoutToast.classList.remove('show');
        } else {
          el.cartDrawer.classList.add('open');
          el.cartDrawer.setAttribute('aria-hidden','false');
          el.filtersDrawer.classList.remove('open');
          el.filtersDrawer.setAttribute('aria-hidden','true');
          renderCart();
        }
      }
      function closeDrawer(){
        el.filtersDrawer.classList.remove('open');
        el.filtersDrawer.setAttribute('aria-hidden','true');
        el.cartDrawer.classList.remove('open');
        el.cartDrawer.setAttribute('aria-hidden','true');
        el.checkoutToast.classList.remove('show');
        el.overlay.classList.remove('open');
      }

      // Cart
      function loadCart(){
        try{
          const raw = localStorage.getItem('scm_cart_simple_v1');
          if(!raw) return [];
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed)) return parsed.filter(x => x && typeof x.productId === 'string' && typeof x.qty === 'number');
          return [];
        }catch{ return []; }
      }
      function saveCart(cart){
        try{ localStorage.setItem('scm_cart_simple_v1', JSON.stringify(cart)); }catch{}
      }
      function syncCartBadge(){
        const count = state.cart.reduce((s,l)=>s + l.qty, 0);
        el.cartCount.textContent = String(count);
        el.cartCountMobile.textContent = String(count);
      }
      function addToCart(productId, qty){
        const p = PRODUCTS.find(x => x.id === productId);
        if(!p || !p.inStock) return;

        const q = clamp(qty || 1, 1, 999);
        const existing = state.cart.find(l => l.productId === productId);
        if(existing) existing.qty = clamp(existing.qty + q, 1, 999);
        else state.cart.push({productId, qty:q});

        saveCart(state.cart);
        syncCartBadge();

        if(el.cartDrawer.classList.contains('open')) renderCart();
      }
      function updateCartQty(productId, nextQty){
        const qty = clamp(nextQty, 0, 999);
        const idx = state.cart.findIndex(l => l.productId === productId);
        if(idx < 0) return;
        if(qty === 0) state.cart.splice(idx, 1);
        else state.cart[idx].qty = qty;

        saveCart(state.cart);
        syncCartBadge();
        renderCart();
      }
      function renderCart(){
        const map = new Map(PRODUCTS.map(p => [p.id, p]));
        const lines = state.cart.map(l => {
          const p = map.get(l.productId);
          if(!p) return null;
          return {p, qty:l.qty};
        }).filter(Boolean);

        if(lines.length === 0){
          el.cartBody.innerHTML = `
            <div class="cartEmpty">
              <div class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="22" height="22">
                  <path fill="currentColor" d="M7.2 14h9.95c.47 0 .88-.33.98-.79l1.55-7.2H6.12L5.76 4H3v2h1.2l1.5 9.2c.08.45.47.8.94.8zM7 18c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm10 0c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/>
                </svg>
              </div>
              <h3>Your cart is empty</h3>
              <p>Add items from the catalog to see them here.</p>
              <button class="btn btn--primary" type="button" id="cartContinueBtn">Continue browsing</button>
            </div>
          `;
          document.getElementById('cartContinueBtn').addEventListener('click', closeDrawer);
          el.cartSubtotal.textContent = formatMoney(0);
          return;
        }

        const subtotal = lines.reduce((s, x) => s + x.p.price * x.qty, 0);
        el.cartSubtotal.textContent = formatMoney(subtotal);

        el.cartBody.innerHTML = `
          <div class="cartList">
            ${lines.map(({p,qty}) => `
              <div class="lineItem">
                <div class="liTop">
                  <div style="min-width:0">
                    <p class="liName">${escapeHtml(p.name)}</p>
                    <p class="liSub">${formatMoney(p.price)} ${escapeHtml(p.unit)} · ${escapeHtml(p.origin)}</p>
                  </div>
                  <button class="liRemove" type="button" data-remove="${escapeAttr(p.id)}" aria-label="Remove ${escapeAttr(p.name)}">×</button>
                </div>
                <div class="liBottom">
                  <div class="qctrl">
                    <button type="button" data-dec="${escapeAttr(p.id)}" aria-label="Decrease quantity" ${qty<=1?'disabled':''}>−</button>
                    <input inputmode="numeric" value="${qty}" data-qty="${escapeAttr(p.id)}" aria-label="Quantity" />
                    <button type="button" data-inc="${escapeAttr(p.id)}" aria-label="Increase quantity">+</button>
                  </div>
                  <div class="liTotal">
                    ${formatMoney(p.price * qty)}
                    <small>Line total</small>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
          <div style="margin-top:12px;font-size:12px;color:var(--sub2);font-weight:900">Demo note: taxes and delivery fees are not included.</div>
        `;

        el.cartBody.querySelectorAll('[data-remove]').forEach(b => b.addEventListener('click', () => updateCartQty(b.getAttribute('data-remove'), 0)));
        el.cartBody.querySelectorAll('[data-dec]').forEach(b => b.addEventListener('click', () => {
          const id = b.getAttribute('data-dec');
          const line = state.cart.find(l => l.productId === id);
          if(line) updateCartQty(id, line.qty - 1);
        }));
        el.cartBody.querySelectorAll('[data-inc]').forEach(b => b.addEventListener('click', () => {
          const id = b.getAttribute('data-inc');
          const line = state.cart.find(l => l.productId === id);
          if(line) updateCartQty(id, line.qty + 1);
        }));
        el.cartBody.querySelectorAll('[data-qty]').forEach(inp => inp.addEventListener('input', () => {
          const id = inp.getAttribute('data-qty');
          const n = Number(inp.value);
          if(Number.isFinite(n)) updateCartQty(id, n);
        }));
      }

      // Wire remaining drawer handlers after elements exist
      el.filtersResetBtn.addEventListener('click', () => { resetOnlyFilters(); renderFiltersUI(); scheduleRender(true); });
      el.filtersResetMobileBtn.addEventListener('click', () => { resetOnlyFilters(); renderFiltersUI(); scheduleRender(true); });
      el.filtersApplyMobileBtn.addEventListener('click', closeDrawer);

      // Mobile filters open button may not exist on desktop
      if(el.filtersOpenBtn) el.filtersOpenBtn.addEventListener('click', () => openDrawer('filters'));
      el.filtersCloseBtn.addEventListener('click', closeDrawer);

      // Cart open/close
      el.cartOpenBtn.addEventListener('click', () => openDrawer('cart'));
      el.cartOpenBtnMobile.addEventListener('click', () => openDrawer('cart'));
      el.cartCloseBtn.addEventListener('click', closeDrawer);
      el.clearCartBtn.addEventListener('click', () => { state.cart = []; saveCart(state.cart); syncCartBadge(); renderCart(); });
      el.checkoutBtn.addEventListener('click', () => {
        el.checkoutToast.classList.add('show');
        setTimeout(()=>el.checkoutToast.classList.remove('show'), 2200);
      });

      // Overlay closes drawers
      el.overlay.addEventListener('mousedown', closeDrawer);

      // Reset all
      el.resetAllBtn.addEventListener('click', () => { resetAll(); renderFiltersUI(); scheduleRender(true); });
      el.focusSearchBtn.addEventListener('click', () => el.searchInput.focus());

      // Helpers
      function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
      function formatMoney(n){ return '$' + Number(n).toFixed(2); }
      function removeFromArray(arr, val){ const i = arr.indexOf(val); if(i >= 0) arr.splice(i,1); }
      function escapeHtml(str){
        return String(str).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      }
      function escapeAttr(str){ return escapeHtml(str).replace(/"/g,'&quot;'); }
      function cssEscape(str){ return String(str).replace(/"/g,'\\"'); }
    })();
  </script>
</body>
</html>
